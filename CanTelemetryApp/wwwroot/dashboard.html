<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAN Telemetri Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>

    <style>
        body { background-color: #1a1a2e; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #16213e; border: 1px solid #0f3460; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-title { color: #4ecca3; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .value-text { font-size: 2.5rem; font-weight: bold; color: #fff; }
        .unit-text { font-size: 1rem; color: #aaa; }
        .status-badge { position: fixed; top: 10px; right: 10px; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        
        /* GÃ¶stergeler */
        .indicator { width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-right: 5px; background-color: #555; }
        .indicator.active { background-color: #4ecca3; box-shadow: 0 0 10px #4ecca3; }

        /* --- LOG AKIÅž EFEKTLERÄ° (GÃœNCELLENDÄ°) --- */
        #messageLog {
            min-height: 120px; /* Biraz kÃ¼Ã§Ã¼lttÃ¼k */
            
        }

        /* VarsayÄ±lan (Eski Mesajlar) - MAVÄ° ve KOMPAKT */
        .log-entry {
            background-color: rgba(13, 110, 253, 0.1); /* Hafif Mavi Arkaplan */
            border-left: 3px solid #3498db;             /* Mavi Ã‡izgi */
            color: #a4d4ff;                             /* AÃ§Ä±k Mavi YazÄ± */
            
            /* Kompakt Ayarlar */
            padding: 2px 8px;       /* BoÅŸluklar azaltÄ±ldÄ± */
            margin-bottom: 3px;     /* SatÄ±r arasÄ± mesafe azaltÄ±ldÄ± */
            border-radius: 2px;

            /* Animasyon */
            animation: slideIn 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(-5px);
        }

        /* En Yeni Mesaj - YEÅžÄ°L ve PARLAK */
        .log-entry:first-child {
            background-color: rgba(78, 204, 163, 0.2); /* Hafif YeÅŸil Arkaplan */
            border-left: 3px solid #4ecca3;             /* YeÅŸil Ã‡izgi */
            color: #fff;                                /* Beyaz YazÄ± */
            font-weight: bold;
            font-size: 1.1rem;                         /* Bir tÄ±k daha bÃ¼yÃ¼k */
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>

    <span id="connectionStatus" class="badge bg-danger status-badge">BaÄŸlantÄ± Yok</span>

    <div class="container mt-4">
        <h2 class="mb-4 text-center">ðŸšŒ Elektrikli OtobÃ¼s CanlÄ± Telemetri</h2>

        <div class="row mb-3 text-center">
            <div class="col-12">
                <span class="mx-2"><span id="indCharge" class="indicator"></span> Åžarj Kablosu</span>
                <span class="mx-2"><span id="indMobil" class="indicator"></span> AraÃ§ Hareketli</span>
                <span class="mx-2"><span id="indReady" class="indicator"></span> EV Ready</span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-2"><div class="card p-2 text-center"><h6 class="card-title">HÄ±z (EBS)</h6><div class="value-text"><span id="spdEbs">0</span> <span class="unit-text">km/h</span></div></div></div>
            <div class="col-md-2"><div class="card p-2 text-center"><h6 class="card-title">HÄ±z (TCU)</h6><div class="value-text"><span id="spdTcu">0</span> <span class="unit-text">km/h</span></div></div></div>
            <div class="col-md-2"><div class="card p-2 text-center"><h6 class="card-title">Ä°vme</h6><div class="value-text"><span id="accl">0</span> <span class="unit-text">(m/sÂ²)</span></div></div></div>
            <div class="col-md-2"><div class="card p-2 text-center"><h6 class="card-title">SOC</h6><div class="value-text"><span id="soc">0</span> <span class="unit-text">%</span></div></div></div>
            <div class="col-md-2"><div class="card p-2 text-center"><h6 class="card-title">SOH</h6><div class="value-text"><span id="soh">0</span> <span class="unit-text">%</span></div></div></div>
            <div class="col-md-2"><div class="card p-2 text-center"><h6 class="card-title">TÃ¼ketim</h6><div class="value-text"><span id="consu">0</span> <span class="unit-text">kWh</span></div></div></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="card-title">HÄ±z GrafiÄŸi (CanlÄ±)</h5>
                    <div class="chart-container">
                        <canvas id="speedChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="card-title">Batarya ÅžarjÄ± (SOC)</h5>
                    <div class="chart-container">
                        <canvas id="socChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-8 offset-md-2">
                <h6 class="text-center small mb-2">CAN BUS Mesaj AkÄ±ÅŸÄ±</h6>
                <div id="messageLog">
                    </div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = "/telemetryHub"; 

        // --- CHART AYARLARI ---
        const commonOptions = {
            responsive: true, maintainAspectRatio: false, animation: false,
            interaction: { mode: 'index', intersect: false },
            scales: { x: { display: false }, y: { beginAtZero: true, grid: { color: '#2a2a40' } } },
            elements: { point: { radius: 0 } },
            plugins: { legend: { labels: { color: '#ccc' } } }
        };

        const ctxSpeed = document.getElementById('speedChart').getContext('2d');
        const speedChart = new Chart(ctxSpeed, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'HÄ±z (km/h)', data: [], borderColor: '#4ecca3', borderWidth: 2, fill: true, backgroundColor: 'rgba(78, 204, 163, 0.1)', tension: 0.3 }] },
            options: { ...commonOptions, scales: { ...commonOptions.scales, y: { min: 0, max: 120 } } }
        });

        const ctxSoc = document.getElementById('socChart').getContext('2d');
        const socChart = new Chart(ctxSoc, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'SOC (%)', data: [], borderColor: '#e94560', borderWidth: 2, fill: true, backgroundColor: 'rgba(233, 69, 96, 0.1)', tension: 0.3 }] },
            options: { ...commonOptions, scales: { ...commonOptions.scales, y: { min: 0, max: 100 } } }
        });

        // --- SIGNALR BAÄžLANTISI ---
        const connection = new signalR.HubConnectionBuilder()
            .withUrl(BACKEND_URL)
            .withAutomaticReconnect()
            .build();

        connection.on("TelemetryUpdated", (data) => {
            const now = new Date().toLocaleTimeString();
            const msgId = data.messageId.toLowerCase();
            
            // Log ekle
            addLogEntry(data.messageId, now);

            if (msgId === "0x4c2") {
                document.getElementById("spdEbs").innerText = data.speedEbs.toFixed(1);
                document.getElementById("spdTcu").innerText = data.speedTcu.toFixed(1);
                document.getElementById("accl").innerText = data.accl.toFixed(2);
                document.getElementById("soc").innerText = data.soc.toFixed(1);
                
                // DÃœZELTME: SOH hilesi kaldÄ±rÄ±ldÄ±, ham veri gÃ¶steriliyor.
                document.getElementById("soh").innerText = data.soh.toFixed(1);
                
                document.getElementById("consu").innerText = data.consuAvg.toFixed(3);

                updateChart(speedChart, now, data.speedTcu);
                updateChart(socChart, now, data.soc);
            }
            else if (msgId === "0x4a0") {
                toggleIndicator("indCharge", data.isChargingConnected);
                toggleIndicator("indMobil", data.isVehicleMobil);
                toggleIndicator("indReady", data.isEvReady);
            }
        });

        // --- LOG LÄ°STESÄ° YÃ–NETÄ°MÄ° ---
        function addLogEntry(id, time) {
            const container = document.getElementById("messageLog");
            
            const row = document.createElement("div");
            row.className = "log-entry";
            row.innerHTML = `<span>ðŸ“¡ <strong>${id}</strong></span> <span style="float:right;">${time}</span>`;

            container.prepend(row);

            if (container.children.length > 5) {
                container.lastElementChild.remove();
            }
        }

        function toggleIndicator(elementId, isActive) {
            const el = document.getElementById(elementId);
            if (isActive) el.classList.add("active");
            else el.classList.remove("active");
        }

        function updateChart(chart, label, value) {
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(value);
            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update('none');
        }

        async function start() {
            try {
                await connection.start();
                document.getElementById("connectionStatus").className = "badge bg-success status-badge";
                document.getElementById("connectionStatus").innerText = "Sistem BaÄŸlÄ± ðŸŸ¢";
            } catch (err) {
                setTimeout(start, 5000);
            }
        }
        start();
    </script>
</body>
</html>